<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="../icons/icon16.png" type="image/png">
        <title>Authorization</title>
    </head>
    <body>
        <div id="root"></div>
        <iframe id="loader" style="display:none" height="0" width="0"></iframe>
        <a href="#" id="launcher" style="display:none">Launch</a>
        <script>
            function queryStringAsJson(aQueryString) {
                var asJsonStringify = aQueryString;
                asJsonStringify = asJsonStringify.replace(/&/g, '","');
                asJsonStringify = asJsonStringify.replace(/=/g, '":"');
                asJsonStringify = '{"' + asJsonStringify + '"}';
                asJsonStringify = asJsonStringify.replace(/"(\d+|true|false)"/, function($0, $1) { return $1; });

                return JSON.parse(asJsonStringify);
            }

            // document.write(window.location.href);
            // https://sundayschoolonline.org/oauth/twitter.html?oauth_token=OZrVjQAAAAAAWN0mAAABXLhd-8k&oauth_verifier=jfHJYCrIq7kGHF9iPMmqCS4jYMejVM4I#app=Floppers&protocol=floppers

            // console.log(encodeURIComponent('name=Floppers&service=Twitter&protocol=floppers'));
            try {
                var app = queryStringAsJson(window.location.hash.substr(1)); // skip the leading #
            } catch(ex) {
                var app = {name:'Floppers', service:'Twitter', protocol:'floppers'};
            }

            document.title = app.name + ' - ' + app.service + ' Authorization';
            var url = !app.protocol ? '' : app.protocol + '://auth/' + app.service + window.location.search;

            document.getElementById('launcher').addEventListener('click', openApp, false);

            document.getElementById('root').textContent = 'Approved! You can return to the ' + app.name + ' app and use the ' + app.service + ' features.';


            // window.onload = function() {
                setTimeout(function() {
                    simulateClick('launcher');
                }, 1000);
            // };

            // var leaveCnt = 0;
            // window.addEventListener("beforeunload", function (event) {
            //     leaveCnt++
            //     if (leaveCnt === 1) return;
            //     else event.returnValue = 'Are you sure?'
            //     console.log('event:', event);
            //     event.returnValue = 'asdf'; // JSON.stringify(event);
            // });

            function openApp() {
                var isiOS = navigator.userAgent.match('iPhone') || navigator.userAgent.match('iPod');
                var isAndroid = navigator.userAgent.match('Android');

                if (isAndroid) {
                    window.location = url;
                } else {
                    document.getElementById('loader').src = url;
                }
                document.getElementById('launcher').textContent = 'ok launched';
            }

            // (function(){
            //     openApp();
            // })();

            // function simulateClick(id) {
            //     var evt = document.createEvent("MouseEvents");
            //     evt.initMouseEvent("click", true, true, window, 1, 0, 0, 0, 0,
            //         false, false, false, false, 0, null);

            //     var cb = document.getElementById(id);
            //     cb.dispatchEvent(evt);
            // }

            function simulateClick(id) {
                var el = document.getElementById(id);
                if (el.dispatchEvent) {
                    var e = document.createEvent("MouseEvents");
                    e.initEvent("click", true, true);
                    el.dispatchEvent(e);
                } else {
                    el.click();
                }
            }
        </script>
    </body>
</html>