<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="../icons/icon16.png" type="image/png">
        <title>Authorization</title>
    </head>
    <body>
        <div id="root"></div>
        <iframe id="loader" style="display:none" height="0" width="0"></iframe>
        <a href="#" id="launcher" style="display:none">Launch</a>
        <script>
            var SERVICES = {
                TWITTER: 'TWITTER',
                INSTAGRAM: 'INSTAGRAM'
            }

            function queryStringAsJson(aQueryString) {
                var asJsonStringify = aQueryString;
                asJsonStringify = asJsonStringify.replace(/&/g, '","');
                asJsonStringify = asJsonStringify.replace(/=/g, '":"');
                asJsonStringify = '{"' + asJsonStringify + '"}';
                console.log('asJsonStringify:',asJsonStringify);
                return JSON.parse(asJsonStringify);
            }

            // alert(window.location.href);
            // approve - https://sundayschoolonline.org/auth.html?oauth_token=OZrVjQAAAAAAWN0mAAABXLhd-8k&oauth_verifier=jfHJYCrIq7kGHF9iPMmqCS4jYMejVM4I#app=Floppers&protocol=floppers
            // deny - https://sundayschoolonline.org/auth.html#name=Floppers&service=Twitter&protocol=floppers?denied=x-FoFvAAAAAAAWN0mAAABXLj_4GI
            // console.log(encodeURIComponent('name=Floppers&service=Twitter&protocol=floppers'));

            var href = window.location.href;

            var hash = href.indexOf('#') > -1 ? href.substr(href.indexOf('#') + 1) : '';
            if (hash.indexOf('?') > -1) hash = hash.substr(0, hash.indexOf('?'));

            var search = href.indexOf('?') > -1 ? href.substr(href.indexOf('?') + 1) : '';
            if (search.indexOf('#') > -1) search = search.substr(0, search.indexOf('#'));

            var root = document.getElementById('root');

            if (!hash) {
                root.textContent = 'App details could not be recognized. Error: "invalid hash"';
            } else if (!search) {
                root.textContent = 'Services details could not be extracted. Error: "invalid search"';
            } else {
                var app = queryStringAsJson(hash); // {name: proper cased name service:service code all caps, same as what i use in application js files, protocol:}
                document.title = app.name + ' - ' + getServiceName() + ' Authorization';

                var details = extractDetails();
                console.log('details:', details);
                var url = app.protocol + '://auth?' + encodeURIComponent(JSON.stringify(details));
                if (details.approved) {
                    root.textContent = 'Approved! You can return to the ' + app.name + ' app and use the ' + getServiceName() + ' features.';
                } else {
                    root.textContent = 'You denied permission. You will not able to use the ' + getServiceName() + ' features in the '+ app.name +' app.';
                }

                document.getElementById('launcher').addEventListener('click', openApp, false);
                setTimeout(function() {
                    simulateClick('launcher');
                }, 1000);
            }

            function getServiceName() {
                switch (app.service) {
                    case SERVICES.TWITTER: return 'Twitter'
                    case SERVICES.INSTAGRAM: return 'Instagram'
                }
            }

            function extractDetails() {
                // crossserver-link18283
                /* returns
                {
                    allowed: bool,
                    TWITTER-true:
                        oauth_token
                        oauth_verifier
                    TWITTER-false:
                        denied
                }
                */
                var extract;
                switch (app.service) {
                    default:
                        extract = queryStringAsJson(search);
                }

                var approved;
                switch (app.service) {
                    case SERVICES.TWITTER:
                            if (extract.denied) approved = false;
                            else if (extract.oauth_token) approved = true;
                            else approved = false;
                        break;
                    case SERVICES.INSTAGRAM:
                            approved = false;
                        break;
                    default:
                        approved = false;
                }

                var details = extract;
                details.approved = approved;

                details.service = app.service;

                return details;
            }

            function openApp() {
                var isiOS = navigator.userAgent.match('iPhone') || navigator.userAgent.match('iPod');
                var isAndroid = navigator.userAgent.match('Android');

                if (isAndroid) {
                    window.location = url;
                } else {
                    document.getElementById('loader').src = url;
                }
                document.getElementById('launcher').textContent = 'ok launched';
            }

            function simulateClick(id) {
                var el = document.getElementById(id);
                if (el.dispatchEvent) {
                    var e = document.createEvent("MouseEvents");
                    e.initEvent("click", true, true);
                    el.dispatchEvent(e);
                } else {
                    el.click();
                }
            }
        </script>
    </body>
</html>